name: Security Scans CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security-scans:
    runs-on: ubuntu-latest
    steps:

      # 1️ Checkout the repository
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2️ Set up Docker
      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      # 3️ Create reports folder
      - name: Create reports folder
        run: mkdir -p reports

      # 4️ Run Semgrep
      - name: Run Semgrep
        run: |
          docker run --rm -v ${{ github.workspace }}/repo:/src semgrep/semgrep \
          semgrep --config=auto /src > reports/semgrep_report.txt

      # 5️ Run OWASP ZAP Baseline Scan
      - name: Run OWASP ZAP
        run: |
          docker run --rm -v ${{ github.workspace }}/reports:/zap/wrk \
          zaproxy/zap-stable zap-baseline.py -t http://host.docker.internal:8000 \
          -r /zap/wrk/zap_report.html

      # 6️ Run Nuclei Scan
      - name: Run Nuclei
        run: |
          docker run --rm -v ${{ github.workspace }}/reports:/root \
          projectdiscovery/nuclei -u http://host.docker.internal:8000 \
          -o /root/nuclei_report.txt

      # 7️ Upload reports as artifacts
      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: reports/